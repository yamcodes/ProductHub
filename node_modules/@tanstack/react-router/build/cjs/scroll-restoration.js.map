{"version":3,"file":"scroll-restoration.js","sources":["../../src/scroll-restoration.tsx"],"sourcesContent":["import * as React from 'react'\n\nconst useLayoutEffect =\n  typeof window !== 'undefined' ? React.useLayoutEffect : React.useEffect\n\nimport { ParsedLocation } from './location'\nimport { useRouter } from './RouterProvider'\nimport { NonNullableUpdater, functionalUpdate } from './utils'\n\nconst windowKey = 'window'\nconst delimiter = '___'\n\nlet weakScrolledElements = new WeakSet<any>()\n\ntype CacheValue = Record<string, { scrollX: number; scrollY: number }>\ntype CacheState = {\n  cached: CacheValue\n  next: CacheValue\n}\n\ntype Cache = {\n  state: CacheState\n  set: (updater: NonNullableUpdater<CacheState>) => void\n}\n\nlet cache: Cache\n\nconst sessionsStorage = typeof window !== 'undefined' && window.sessionStorage\n\nexport type ScrollRestorationOptions = {\n  getKey?: (location: ParsedLocation) => string\n}\n\nconst defaultGetKey = (location: ParsedLocation) => location.state.key!\n\nexport function useScrollRestoration(options?: ScrollRestorationOptions) {\n  const { state, subscribe, resetNextScrollRef } = useRouter()\n\n  useLayoutEffect(() => {\n    const getKey = options?.getKey || defaultGetKey\n\n    if (sessionsStorage) {\n      if (!cache) {\n        cache = (() => {\n          const storageKey = 'tsr-scroll-restoration-v2'\n\n          const state: CacheState = JSON.parse(\n            window.sessionStorage.getItem(storageKey) || 'null',\n          ) || { cached: {}, next: {} }\n\n          return {\n            state,\n            set: (updater) => {\n              cache.state = functionalUpdate(updater, cache.state)\n              window.sessionStorage.setItem(\n                storageKey,\n                JSON.stringify(cache.state),\n              )\n            },\n          }\n        })()\n      }\n    }\n\n    const { history } = window\n    if (history.scrollRestoration) {\n      history.scrollRestoration = 'manual'\n    }\n\n    const onScroll = (event: Event) => {\n      if (weakScrolledElements.has(event.target)) return\n      weakScrolledElements.add(event.target)\n\n      const elementSelector =\n        event.target === document || event.target === window\n          ? windowKey\n          : getCssSelector(event.target)\n\n      if (!cache.state.next[elementSelector]) {\n        cache.set((c) => ({\n          ...c,\n          next: {\n            ...c.next,\n            [elementSelector]: {\n              scrollX: NaN,\n              scrollY: NaN,\n            },\n          },\n        }))\n      }\n    }\n\n    const getCssSelector = (el: any): string => {\n      let path = [],\n        parent\n      while ((parent = el.parentNode)) {\n        path.unshift(\n          `${el.tagName}:nth-child(${\n            ([].indexOf as any).call(parent.children, el) + 1\n          })`,\n        )\n        el = parent\n      }\n      return `${path.join(' > ')}`.toLowerCase()\n    }\n\n    if (typeof document !== 'undefined') {\n      document.addEventListener('scroll', onScroll, true)\n    }\n\n    const unsubOnBeforeLoad = subscribe('onBeforeLoad', (event) => {\n      if (event.pathChanged) {\n        const restoreKey = getKey(event.fromLocation)\n        for (const elementSelector in cache.state.next) {\n          const entry = cache.state.next[elementSelector]!\n          if (elementSelector === windowKey) {\n            entry.scrollX = window.scrollX || 0\n            entry.scrollY = window.scrollY || 0\n          } else if (elementSelector) {\n            const element = document.querySelector(elementSelector)\n            entry.scrollX = element?.scrollLeft || 0\n            entry.scrollY = element?.scrollTop || 0\n          }\n\n          cache.set((c) => {\n            const next = { ...c.next }\n            delete next[elementSelector]\n\n            return {\n              ...c,\n              next,\n              cached: {\n                ...c.cached,\n                [[restoreKey, elementSelector].join(delimiter)]: entry,\n              },\n            }\n          })\n        }\n      }\n    })\n\n    const unsubOnResolved = subscribe('onResolved', (event) => {\n      if (event.pathChanged) {\n        if (!resetNextScrollRef.current) {\n          return\n        }\n\n        resetNextScrollRef.current = true\n\n        const getKey = options?.getKey || defaultGetKey\n\n        const restoreKey = getKey(event.toLocation)\n        let windowRestored = false\n\n        for (const cacheKey in cache.state.cached) {\n          const entry = cache.state.cached[cacheKey]!\n          const [key, elementSelector] = cacheKey.split(delimiter)\n          if (key === restoreKey) {\n            if (elementSelector === windowKey) {\n              windowRestored = true\n              window.scrollTo(entry.scrollX, entry.scrollY)\n            } else if (elementSelector) {\n              const element = document.querySelector(elementSelector)\n              if (element) {\n                element.scrollLeft = entry.scrollX\n                element.scrollTop = entry.scrollY\n              }\n            }\n          }\n        }\n\n        if (!windowRestored) {\n          window.scrollTo(0, 0)\n        }\n\n        cache.set((c) => ({ ...c, next: {} }))\n        weakScrolledElements = new WeakSet<any>()\n      }\n    })\n\n    return () => {\n      document.removeEventListener('scroll', onScroll)\n      unsubOnBeforeLoad()\n      unsubOnResolved()\n    }\n  }, [])\n}\n\nexport function ScrollRestoration(props: ScrollRestorationOptions) {\n  useScrollRestoration(props)\n  return null\n}\n"],"names":["useLayoutEffect","window","React","useEffect","windowKey","delimiter","weakScrolledElements","WeakSet","cache","sessionsStorage","sessionStorage","defaultGetKey","location","state","key","useScrollRestoration","options","subscribe","resetNextScrollRef","useRouter","getKey","storageKey","JSON","parse","getItem","cached","next","set","updater","functionalUpdate","setItem","stringify","history","scrollRestoration","onScroll","event","has","target","add","elementSelector","document","getCssSelector","c","scrollX","NaN","scrollY","el","path","parent","parentNode","unshift","tagName","indexOf","call","children","join","toLowerCase","addEventListener","unsubOnBeforeLoad","pathChanged","restoreKey","fromLocation","entry","element","querySelector","scrollLeft","scrollTop","unsubOnResolved","current","toLocation","windowRestored","cacheKey","split","scrollTo","removeEventListener","ScrollRestoration","props"],"mappings":"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"}